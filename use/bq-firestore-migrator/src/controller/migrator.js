import bigquery from "../service/bigquery.js";
import firestore from "../service/firestore.js";
import alert from "../util/alert.js";
import logger from "../util/logger.js";
import helper from "../util/helper.js";

/**
 * Controlador respons√°vel por orquestrar a migra√ß√£o de dados do BigQuery para o Firestore.
 * 
 * @module controller/migrator
 */
const run = async () => {
    const functionName = helper.getStackTraceDetails();
    logger.info("Iniciando migra√ß√£o de estabelecimentos...", functionName);
    await alert.send("üèÇ Iniciando a migra√ß√£o dos estabelecimentos para Firestore.");

    try {
        let totalProcessed = 0;
        for await (const batch of bigquery.fetchEstabelecimentos()) {
            await firestore.saveEstabelecimentos(batch);
            totalProcessed += batch.length;
            logger.info(`Lote processado com ${batch.length} registros. Total at√© agora: ${totalProcessed}`, functionName);
            await alert.send(`üì¶ Lote processado com ${batch.length} registros. Total at√© agora: ${totalProcessed}`);
        }

        logger.info("Migra√ß√£o conclu√≠da com sucesso!", functionName);
        await alert.send(`ü´° Migra√ß√£o finalizada! Total de registros migrados: ${totalProcessed}`);
    } catch (e) {
        logger.error(e, functionName);
        await alert.send(`‚ùå Falha na migra√ß√£o: ${e.message}`);
        throw e;
    }
};

export default { run };
