# bq-firestore-migrator

Este √© um [Cloud Run Job](https://cloud.google.com/run/docs/create-jobs), constru√≠do em [NodeJS](https://nodejs.org). O job √© respons√°vel por copiar os registros da camada gold presentes no [BigQuery](https://cloud.google.com/bigquery) para o [Firestore](https://firebase.google.com/docs/firestore), possibilitando o consumo do dado com um baixo tempo de resposta.

## üèó Estrutura

```
‚îÇ‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.js          # Vari√°veis de ambiente
|   |
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrator.js     # Orquestra a c√≥pia dos dados
|   |
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bigquery.js     # Obt√©m dados do BigQuery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firestore.js    # Salva dados no Firestore
|   |
‚îÇ   ‚îú‚îÄ‚îÄ util/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.js       # Logs estruturados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alert.js        # Envio de alertas para o Slack
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ helper.js       # Fun√ß√µes auxiliares
|   |
‚îÇ   ‚îú‚îÄ‚îÄ main.js             # Ponto de entrada do processo
|
‚îÇ‚îÄ‚îÄ package.json            # Depend√™ncias do projeto
‚îÇ‚îÄ‚îÄ Dockerfile              # Configura√ß√£o do container Docker
‚îÇ‚îÄ‚îÄ deploy.sh               # Script de deploy
```

## ü©∫ Como funciona

Este job ser√° executado 1x por dia na **regi√£o** `us-central1`, com 1 CPU, 512MB de mem√≥ria, sem retry e cria√ß√£o de apenas 1 task. O processo dura cerca de 30 minutos e obt√©m todos os dados do BigQuery e os armazena no Firestore.

### 1. Obten√ß√£o dos dados do BigQuery

Apenas executa a query no BigQuery, na tabela estabelecimentos, e obt√©m todos os registros.

√â utilizada uma regra de obten√ß√£o por batch, sendo que cada batch possui 500 registros, afim de n√£o armazenarmos os mais de 60 milh√µes de registros em mem√≥ria.

### 2. Inser√ß√£o dos dados no Firestore

A medida em que os batch com os 500 registros s√£o recebidos, os mesmos v√£o sendo persistidos no Firestore (banco de dados NoSQL de baixa lat√™ncia).

> Durante todas as etapas, o job gera logs que s√£o enviadas para o [Google Cloud Logging](https://cloud.google.com/logging), al√©m de alertas para um canal no [Slack](https://slack.com).

## üíµ Custos

Considerando as condi√ß√µes de execu√ß√£o e a as tabelas de pre√ßos do [Cloud Run](https://cloud.google.com/run/pricing), [BigQuery](https://cloud.google.com/bigquery/pricing) e [Firestore](https://cloud.google.com/firestore/pricing) com o free tier, temos os seguintes custos:

| **Servi√ßo** | **Opera√ß√£o** | **Custo por Unidade** | **Uso Estimado** | **Custo Estimado (USD)** |
|-------------|--------------|-----------------------|------------------|--------------------------|
| **Cloud Run Job** | Tempo de CPU | $0.000024 por vCPU-seg | 1 vCPU por **30 min (1800 seg)** | **$0.0432** |
|                   | Tempo de Mem√≥ria | $0.0000025 por GB-seg   | **512MB** por **30 min (1800 seg)** | **$0.00225** |
|                   | Solicita√ß√µes | $0.40 por 1M solicita√ß√µes | **1 solicita√ß√£o** (√∫nica execu√ß√£o) | **$0.0000004** |
| **BigQuery** | Consulta de Dados | $5.00 por TB processado  | **40GB (0.04 TB)**  | **$0.20** (ou **$0.00** se dentro do free tier) |
| **Firestore** | Grava√ß√£o de Documentos | $0.18 por 100K grava√ß√µes | **65 milh√µes** de grava√ß√µes | **$117.00** |
|               | Armazenamento Mensal | $0.18 por GB por m√™s | **40GB armazenados** | **$7.20** |
| **Total mensal estimado** | **‚Äî** | **‚Äî** | **‚Äî** | **$124.25** |

## üõ†Ô∏è Como realizar o deploy

Certifique-se de ter instalado o [Google Cloud SDK CLI](https://cloud.google.com/sdk/docs/install), [Docker](https://docs.docker.com/desktop/) e [NodeJS](https://nodejs.org). Sua conta de e-mail vinculada ao projeto do Google Cloud tamb√©m deve ter as permiss√µes necess√°rias.

Para realizar o deploy, execute o script [`deploy.sh`](./deploy.sh) e configure as vari√°veis no in√≠cio do arquivo.

Para executar o job no Google Cloud:
```sh
gcloud run jobs execute $JOB_NAME --region=$REGION
```

> Esta etapa tamb√©m pode ser realizada via [Google Console](https://console.cloud.google.com/run/jobs).

## ü™õ Como executar localmente

Crie um arquivo `.env` na raiz do projeto:
```env
PROCESS=bq-firestore-migrator

GOOGLE_CLOUD_PROJECT=cloud-cnpj
GOOGLE_CLOUD_REGION=us-central1
BIGQUERY_DATASET=gold
BIGQUERY_TABLE=estabelecimentos

FIRESTORE_COLLECTION=estabelecimentos

LOG_ENABLED=true
SLACK_NOTIFICATIONS_ENABLED=true
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
```

Instale as depend√™ncias e execute o job localmente:
```sh
npm install
npm start
```

> Se n√£o for usar notifica√ß√µes do Slack, n√£o √© necess√°rio configurar a URL. Para ativ√°-las, siga [estas instru√ß√µes](https://api.slack.com/messaging/webhooks).
